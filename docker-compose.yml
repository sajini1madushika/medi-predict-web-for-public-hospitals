version: "3.8"

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    working_dir: /app
    env_file:
      - ./backend/.env
    environment:
      - PYTHONUNBUFFERED=1
      - RASA_REST_URL=http://chatbot:5005/webhooks/rest/webhook
      - CORS_ORIGINS=http://localhost:5173
    ports:
      - "8000:8000"
    depends_on:
      - chatbot

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    working_dir: /app
    env_file:
      - ./frontend/.env
    environment:
      - VITE_API_BASE=http://backend:8000
    ports:
      - "5173:5173"
    depends_on:
      - backend

  chatbot:
    image: rasa/rasa:3.6.20
    working_dir: /app
    volumes:
      - ./chatbot:/app
      - ./chatbot/models:/app/models
      - ./chatbot/logs:/app/logs
    entrypoint: [""]
    command: >
      bash -c "rasa train && rasa run --enable-api --cors '*' --port 5005 --endpoints endpoints.yml"
    environment:
      - RASA_TELEMETRY_ENABLED=0
    ports:
      - "5005:5005"
    depends_on:
      - actions

  actions:
    image: rasa/rasa-sdk:3.6.2
    working_dir: /app
    volumes:
      - ./chatbot:/app
      - ./chatbot/logs:/app/logs
    entrypoint: [""]
    command: >
      bash -c "pip install -r requirements.txt 2>/dev/null || true; python -m rasa_sdk --actions actions --port 5055"
    environment:
      - RASA_TELEMETRY_ENABLED=0
    ports:
      - "5055:5055"
